flowchart TD
    START([Device acceso]) --> MEASURE[ğŸ“ Device misura<br/>distanza, temp, battery]
    MEASURE --> ENCODE[ğŸ” Device codifica<br/>in hex string]
    ENCODE --> SEND[ğŸ“¤ POST /gateway/telemetry]
    
    SEND --> GW_RECV[ğŸšª Gateway riceve]
    GW_RECV --> GW_SELECT{âš–ï¸ Seleziona istanza<br/>RoundRobin}
    
    GW_SELECT -->|Instance 1| M1_RECV[âš¡ Meteor 1]
    GW_SELECT -->|Instance 2| M2_RECV[âš¡ Meteor 2]
    GW_SELECT -->|Instance 3| M3_RECV[âš¡ Meteor 3]
    
    M1_RECV --> DECODE
    M2_RECV --> DECODE
    M3_RECV --> DECODE
    
    DECODE[ğŸ” Decode hex<br/>â†’ DecodedMessage]
    DECODE --> EXTRACT[ğŸ“Š Estrai campi<br/>IMEI, battery, etc.]
    EXTRACT --> SAVE[ğŸ’¾ Salva in DB]
    
    SAVE --> CHECK_CMD{ğŸ“‹ Ci sono comandi<br/>pendenti?}
    
    CHECK_CMD -->|No| RESP_NO[ğŸ“¨ Risposta senza comandi]
    CHECK_CMD -->|SÃ¬| GET_CMD[ğŸ“¥ Recupera comandi da DB]
    
    GET_CMD --> ENCODE_CMD[ğŸ”§ Codifica comandi<br/>â†’ hex string]
    ENCODE_CMD --> MARK_SENT[âœ… Marca comandi<br/>come SENT]
    MARK_SENT --> RESP_YES[ğŸ“¨ Risposta con comandi]
    
    RESP_NO --> GW_FORWARD
    RESP_YES --> GW_FORWARD
    
    GW_FORWARD[ğŸšª Gateway inoltra risposta]
    GW_FORWARD --> DEV_EXEC[ğŸ“¡ Device riceve<br/>ed esegue comandi]
    
    DEV_EXEC --> END([Fine ciclo])
    
    style START fill:#e1f5ff
    style MEASURE fill:#d4edda
    style ENCODE fill:#fff3cd
    style SEND fill:#ffc107
    style GW_RECV fill:#fff3cd
    style DECODE fill:#d4edda
    style SAVE fill:#f8d7da
    style ENCODE_CMD fill:#ffd4d4
    style END fill:#e1f5ff